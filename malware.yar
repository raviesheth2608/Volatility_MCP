rule MZ_Executable_In_Memory
{
    meta:
        description = "Detects PE files injected in memory"
        author = "Volatility MCP"
        severity = "high"
    strings:
        $mz = "MZ"
        $pe = { 50 45 00 00 }  // "PE" followed by two null bytes in hex
    condition:
        $mz at 0 and $pe
}

rule Shellcode_NOPSled
{
    meta:
        description = "Detects NOP sleds (shellcode padding)"
        severity = "medium"
    strings:
        $nops = { 90 90 90 90 90 90 }
    condition:
        $nops
}

rule Meterpreter_Reverse_TCP
{
    meta:
        description = "Metasploit Meterpreter reverse shell"
        threat = "APT / Pentest"
        severity = "critical"
    strings:
        $a = "metsrv" ascii
        $b = "stdapi" ascii
        $c = "ReflectiveLoader" ascii
    condition:
        2 of them
}

rule CobaltStrike_Beacon
{
    meta:
        description = "Detects Cobalt Strike beacon in memory"
        severity = "critical"
    strings:
        $a = "beacon.dll" ascii
        $b = "ArtifactKit" ascii
        $c = "Malleable" ascii
    condition:
        any of them
}

rule Process_Injection_APIs
{
    meta:
        description = "Common process injection APIs"
        severity = "high"
    strings:
        $a = "VirtualAllocEx"
        $b = "WriteProcessMemory"
        $c = "CreateRemoteThread"
        $d = "NtQueueApcThread"
    condition:
        2 of them
}

rule Suspicious_PowerShell
{
    meta:
        description = "Encoded or malicious PowerShell"
        severity = "medium"
    strings:
        $a = "FromBase64String"
        $b = "Invoke-Expression"
        $c = "IEX"
        $d = "DownloadString"
    condition:
        2 of them
}

rule Ransomware_Markers
{
    meta:
        description = "Common ransomware code patterns"
        severity = "critical"
    strings:
        $a = "AES" wide
        $b = "RSA" wide
        $c = "encrypt" wide
        $d = "decrypt" wide
        $e = ".locked" wide
        $f = ".crypted" wide
    condition:
        3 of them
}